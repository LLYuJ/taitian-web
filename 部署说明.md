# 生产环境部署指南

## 部署架构

```
用户
  ↓
Nginx (反向代理)
  ↓
├─→ 前端静态文件 (Vue构建后的dist目录)
└─→ 后端API (FastAPI + Uvicorn/Gunicorn)
      ↓
    SQLite数据库
```

## 服务器要求

- 操作系统: Linux (推荐 Ubuntu 20.04+)
- RAM: 2GB+
- 磁盘: 10GB+
- Python: 3.10+
- Node.js: 16+
- Nginx: 1.18+

## 部署步骤

### 1. 服务器准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3.10 python3-pip nginx git

# 安装 uv
curl -LsSf https://astral.sh/uv/install.sh | sh
source $HOME/.cargo/env

# 安装 Node.js (使用 nvm)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 2. 部署后端

```bash
# 创建应用目录
sudo mkdir -p /var/www/taitian
sudo chown $USER:$USER /var/www/taitian

# 克隆或上传项目
cd /var/www/taitian
# git clone your-repo-url .
# 或使用 scp/rsync 上传文件

# 安装后端依赖
cd backend
uv pip install -e .

# 配置环境变量
cp .env.example .env
nano .env
# 修改 SECRET_KEY、DATABASE_URL 等配置

# 初始化数据库
uv run python -c "from app.core.database import init_db; import asyncio; asyncio.run(init_db())"

# 创建 systemd 服务
sudo nano /etc/systemd/system/taitian-backend.service
```

**taitian-backend.service 内容**:

```ini
[Unit]
Description=Taitian Backend API
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/taitian/backend
Environment="PATH=/home/YOUR_USER/.cargo/bin:/usr/local/bin:/usr/bin"
ExecStart=/home/YOUR_USER/.cargo/bin/uv run uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 4

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable taitian-backend
sudo systemctl start taitian-backend
sudo systemctl status taitian-backend
```

### 3. 部署前端

```bash
cd /var/www/taitian/frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 构建后的文件在 dist 目录
```

### 4. 配置 Nginx

```bash
sudo nano /etc/nginx/sites-available/taitian
```

**Nginx 配置文件内容**:

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # 前端静态文件
    root /var/www/taitian/frontend/dist;
    index index.html;
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 文件上传
    location /uploads/ {
        alias /var/www/taitian/backend/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/taitian /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 5. 配置 HTTPS (使用 Let's Encrypt)

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 自动续期（Certbot 会自动配置）
sudo certbot renew --dry-run
```

### 6. 配置防火墙

```bash
# UFW 防火墙
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
sudo ufw status
```

### 7. 设置文件权限

```bash
# 后端上传目录权限
sudo chown -R www-data:www-data /var/www/taitian/backend/uploads
sudo chmod -R 755 /var/www/taitian/backend/uploads

# 数据库文件权限
sudo chown www-data:www-data /var/www/taitian/backend/taitian.db
sudo chmod 644 /var/www/taitian/backend/taitian.db
```

## 监控和维护

### 查看后端日志

```bash
# 实时日志
sudo journalctl -u taitian-backend -f

# 最近的日志
sudo journalctl -u taitian-backend -n 100
```

### 重启服务

```bash
# 重启后端
sudo systemctl restart taitian-backend

# 重启 Nginx
sudo systemctl restart nginx
```

### 更新部署

```bash
# 更新后端
cd /var/www/taitian/backend
git pull  # 或上传新文件
uv pip install -e .
sudo systemctl restart taitian-backend

# 更新前端
cd /var/www/taitian/frontend
git pull  # 或上传新文件
npm install
npm run build
```

### 备份数据库

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-taitian.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/taitian"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
cp /var/www/taitian/backend/taitian.db $BACKUP_DIR/taitian_$DATE.db

# 备份上传的文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/taitian/backend/uploads/

# 删除30天前的备份
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
```

```bash
# 设置执行权限
sudo chmod +x /usr/local/bin/backup-taitian.sh

# 添加到 crontab（每天凌晨2点备份）
sudo crontab -e
# 添加: 0 2 * * * /usr/local/bin/backup-taitian.sh
```

## 性能优化

### 1. 数据库优化

如果数据量较大，考虑使用 PostgreSQL 替代 SQLite：

```python
# backend/app/core/config.py
DATABASE_URL = "postgresql+asyncpg://user:password@localhost/taitian"
```

### 2. 静态文件 CDN

将静态资源上传到 CDN（如阿里云 OSS、腾讯云 COS）：

```javascript
// frontend/vite.config.js
export default defineConfig({
  base: 'https://cdn.yourdomain.com/',
  // ...
})
```

### 3. 启用 Redis 缓存

```bash
sudo apt install redis-server
```

## 安全建议

1. ✅ 修改默认管理员密码
2. ✅ 使用强 SECRET_KEY
3. ✅ 启用 HTTPS
4. ✅ 配置防火墙
5. ✅ 定期更新系统和依赖
6. ✅ 限制文件上传大小
7. ✅ 启用日志审计
8. ✅ 定期备份数据

## 常见问题

### 1. 502 Bad Gateway
检查后端服务是否运行：`sudo systemctl status taitian-backend`

### 2. 文件上传失败
检查上传目录权限和 Nginx `client_max_body_size` 配置

### 3. 静态文件 404
检查 Nginx 配置中的路径是否正确

### 4. 数据库锁定错误
SQLite 不适合高并发，建议迁移到 PostgreSQL

## 技术支持

如遇问题，请检查：
- 后端日志: `sudo journalctl -u taitian-backend -f`
- Nginx 日志: `sudo tail -f /var/log/nginx/error.log`
- 系统日志: `sudo journalctl -xe`

